---
interface Props {
  messages?: string[];
  typingSpeed?: number;
  pauseDuration?: number;
  cursorChar?: string;
}
const {
  messages = ["Oh hey there.", "Hope you find what you're looking for."],
  typingSpeed = 50,
  pauseDuration = 2200,
  cursorChar = "_",
} = Astro.props;
---
<div class="typing-intro" id="typing-intro" data-messages={JSON.stringify(messages)} data-typing-speed={typingSpeed} data-pause={pauseDuration} data-cursor={cursorChar}>
  <div class="typing-intro__screen">
    <div class="typing-intro__text" id="typing-intro-text"></div>
    <span class="typing-intro__cursor" id="typing-intro-cursor">{cursorChar}</span>
  </div>
</div>

<style>
  .typing-intro {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .typing-intro.is-done {
    pointer-events: none;
  }
  .typing-intro__screen {
    max-width: 90%;
    padding: 2rem;
  }
  .typing-intro__text {
    font-family: 'Courier New', Consolas, monospace;
    font-size: clamp(1rem, 3vw, 1.35rem);
    color: #c0c0c0;
    margin: 0 0 0.25em;
    line-height: 1.6;
    min-height: 1.6em;
  }
  .typing-intro__text .typing-intro__line {
    display: block;
  }
  .typing-intro__cursor {
    font-family: 'Courier New', Consolas, monospace;
    font-size: inherit;
    color: #c0c0c0;
    animation: typing-cursor-blink 0.6s step-end infinite;
  }
  @keyframes typing-cursor-blink {
    50% { opacity: 0; }
  }
</style>

<script>
  import { gsap } from 'gsap';

  function runTypingIntro() {
    const el = document.getElementById('typing-intro');
    const textEl = document.getElementById('typing-intro-text');
    const cursorEl = document.getElementById('typing-intro-cursor');
    if (!el || !textEl || !cursorEl) return;

    const messages = JSON.parse(el.dataset.messages || '["Oh hey there.", "Hope you find what you\'re looking for."]');
    const typingSpeed = Number(el.dataset.typingSpeed) || 50;
    const pauseDuration = Number(el.dataset.pause) || 2200;

    let msgIndex = 0;
    let charIndex = 0;
    let timeout;

    function type() {
      const msg = messages[msgIndex];
      if (charIndex < msg.length) {
        const prefix = msgIndex === 0 ? '' : messages.slice(0, msgIndex).join(' ') + ' ';
        textEl.textContent = prefix + msg.slice(0, charIndex + 1);
        charIndex++;
        timeout = setTimeout(type, typingSpeed);
        return;
      }
      if (msgIndex < messages.length - 1) {
        msgIndex++;
        charIndex = 0;
        timeout = setTimeout(type, pauseDuration);
        return;
      }
      timeout = setTimeout(() => {
        gsap.to(el, {
          opacity: 0,
          duration: 0.8,
          ease: 'power2.inOut',
          onComplete: () => {
            el.classList.add('is-done');
            el.style.display = 'none';
            document.body.classList.add('typing-intro-complete');
          },
        });
      }, pauseDuration);
    }

    gsap.fromTo(cursorEl, { opacity: 1 }, {
      opacity: 0.3,
      duration: 0.5,
      repeat: -1,
      yoyo: true,
      ease: 'power2.inOut',
    });

    timeout = setTimeout(type, 800);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runTypingIntro);
  } else {
    runTypingIntro();
  }
</script>
